# Function to uninstall Microsoft Teams for a specific user
function Uninstall-TeamsClassic {
    param (
        [string]$TeamsPath
    )

    try {
        if (Test-Path "$TeamsPath\Update.exe") {
            Write-Host "Running Teams uninstaller at $TeamsPath"
            $process = Start-Process -FilePath "$TeamsPath\Update.exe" -ArgumentList "--uninstall /s" -PassThru -Wait -NoNewWindow
            if ($process.ExitCode -ne 0) {
                Write-Error "Uninstallation failed with exit code $($process.ExitCode)."
            } else {
                Write-Host "Successfully uninstalled Teams from $TeamsPath"
            }
        } else {
            Write-Host "Update.exe not found at $TeamsPath, skipping..."
        }
    }
    catch {
        Write-Error $_.Exception.Message
    }
}

# ----------------------- 1Ô∏è‚É£ Remove Teams Machine-Wide Installer -----------------------
$registryPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall"

Write-Host "`nüîç Searching for Teams Machine-Wide Installer..."

$MachineWide = Get-ItemProperty -Path "$registryPath\*" -ErrorAction SilentlyContinue | 
               Where-Object { $_.DisplayName -eq "Teams Machine-Wide Installer" }

if ($MachineWide) {
    Write-Host "üìå Found Teams Machine-Wide Installer. Uninstalling..."
    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($MachineWide.PSChildName) /qn" -NoNewWindow -Wait
    Write-Host "‚úÖ Teams Machine-Wide Installer removed."
} else {
    Write-Host "‚ùå Teams Machine-Wide Installer not found."
}

# ----------------------- 2Ô∏è‚É£ Remove Microsoft Teams for All Users -----------------------
Write-Host "`nüîç Searching for Teams installations for all users..."

$AllUsers = Get-ChildItem -Path "$($ENV:SystemDrive)\Users"

foreach ($User in $AllUsers) {
    Write-Host "üë§ Processing user: $($User.Name)"

    # Define Installation Paths
    $localAppData = "$($ENV:SystemDrive)\Users\$($User.Name)\AppData\Local\Microsoft\Teams"
    $programData = "$($env:ProgramData)\$($User.Name)\Microsoft\Teams"

    if (Test-Path "$localAppData\Current\Teams.exe") {
        Write-Host "  üöÄ Uninstalling Teams for user $($User.Name) from LocalAppData"
        Uninstall-TeamsClassic -TeamsPath $localAppData
    }
    elseif (Test-Path "$programData\Current\Teams.exe") {
        Write-Host "  üöÄ Uninstalling Teams for user $($User.Name) from ProgramData"
        Uninstall-TeamsClassic -TeamsPath $programData
    }
    else {
        Write-Host "  ‚úÖ No Teams installation found for user $($User.Name)."
    }
}

# ----------------------- 3Ô∏è‚É£ Uninstall Microsoft Teams Meeting Add-in for Office -----------------------
Write-Host "`nüîç Searching for Microsoft Teams Meeting Add-in for Microsoft Office..."

$registryPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

$addInName = "Microsoft Teams Meeting Add-in for Microsoft Office"

foreach ($regPath in $registryPaths) {
    $installedApps = Get-ItemProperty -Path "$regPath\*" -ErrorAction SilentlyContinue |
                     Where-Object { $_.DisplayName -like $addInName }

    foreach ($app in $installedApps) {
        if ($app) {
            Write-Host "üìå Found $addInName. Checking install location..."

            $installedSource = $app.InstalledLocation ?? $app.InstallSource

            if ($installedSource -and ($installedSource -notlike "C:\Program Files\WindowsApps*")) {
                Write-Host "üóëÔ∏è Uninstalling $addInName from $installedSource"

                if ($app.PSChildName -match "^{.*}$") {
                    # MSI-based uninstall
                    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($app.PSChildName) /qn" -NoNewWindow -Wait
                }
                elseif ($app.UninstallString) {
                    # EXE-based uninstall
                    $uninstallCmd = $app.UninstallString
                    Write-Host "Running: $uninstallCmd"
                    Start-Process -FilePath "cmd.exe" -ArgumentList "/c $uninstallCmd" -NoNewWindow -Wait
                }

                Write-Host "‚úÖ $addInName successfully uninstalled."
            } else {
                Write-Host "‚ùå $addInName is installed in WindowsApps and will not be removed."
            }
        }
    }
}

# ----------------------- 4Ô∏è‚É£ Remove Leftover Teams Folders & Icons -----------------------
Write-Host "`nüóëÔ∏è Removing old Teams folders and shortcuts..."

$TeamsFolders = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Local\Microsoft\Teams" -ErrorAction SilentlyContinue
$TeamsIcons = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\" -Filter "Microsoft Teams*.lnk" -Recurse -ErrorAction SilentlyContinue

foreach ($folder in $TeamsFolders) {
    Write-Host "üóëÔ∏è Removing: $($folder.FullName)"
    Remove-Item -Path $folder.FullName -Force -Recurse -ErrorAction SilentlyContinue
}

foreach ($icon in $TeamsIcons) {
    Write-Host "üóëÔ∏è Removing: $($icon.FullName)"
    Remove-Item -Path $icon.FullName -Force -ErrorAction SilentlyContinue
}

Write-Host "`n‚úÖ Microsoft Teams and related components have been successfully uninstalled!"
