Add-Type -AssemblyName PresentationFramework

# Define XAML for WPF Layout
[xml]$xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Device Collection Management" Height="400" Width="600" WindowStartupLocation="CenterScreen">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <TextBlock Grid.Row="0" FontSize="18" FontWeight="Bold" Text="Device Collection Management" HorizontalAlignment="Center" Margin="0,0,0,10"/>
        
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,5">
            <TextBlock Text="Old Device Name:" VerticalAlignment="Center" Width="120"/>
            <TextBox x:Name="OldDeviceNameTextBox" Width="200" Margin="10,0"/>
            <Button x:Name="GetCollectionsButton" Content="Get Collections" Width="100" Margin="10,0"/>
        </StackPanel>
        
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,5">
            <TextBlock Text="New Device Name:" VerticalAlignment="Center" Width="120"/>
            <TextBox x:Name="NewDeviceNameTextBox" Width="200" Margin="10,0"/>
            <Button x:Name="CheckDeviceButton" Content="Check Device" Width="100" Margin="10,0" IsEnabled="False"/>
        </StackPanel>
        
        <Button Grid.Row="3" x:Name="AddNewDeviceButton" Content="Add New Device to Collections" Background="Red" Foreground="White" Width="300" Height="30" HorizontalAlignment="Center" Margin="0,10"/>
        
        <ListBox Grid.Row="4" x:Name="OutputListBox" Margin="0,10,0,0" />
    </Grid>
</Window>
"@

# Load XAML
$reader = (New-Object System.Xml.XmlNodeReader $xaml)
$window = [System.Windows.Markup.XamlReader]::Load($reader)

# Define Controls
$oldDeviceNameTextBox = $window.FindName("OldDeviceNameTextBox")
$newDeviceNameTextBox = $window.FindName("NewDeviceNameTextBox")
$getCollectionsButton = $window.FindName("GetCollectionsButton")
$checkDeviceButton = $window.FindName("CheckDeviceButton")
$addNewDeviceButton = $window.FindName("AddNewDeviceButton")
$outputListBox = $window.FindName("OutputListBox")

# Placeholder for collections retrieved
$collectionsList = @()

# Helper function to update output
function Update-Output {
    param (
        [string]$message
    )
    # Update the OutputListBox on the main thread
    $window.Dispatcher.Invoke([action]{ $outputListBox.Items.Add($message) })
}

# Event Handler for Get Collections button
$getCollectionsButton.Add_Click({
    $oldDeviceName = $oldDeviceNameTextBox.Text
    if ([string]::IsNullOrWhiteSpace($oldDeviceName)) {
        [System.Windows.MessageBox]::Show("Please enter the old device name.", "Input Error", [System.Windows.MessageBoxButton]::OK, [System.Windows.MessageBoxImage]::Warning)
        return
    }

    # Run in a job to keep UI responsive
    Start-Job -ScriptBlock {
        param ($oldDeviceName)
        
        # Check if the device exists
        $device = Get-CMDevice -Name $oldDeviceName -ErrorAction SilentlyContinue
        if ($null -ne $device) {
            Update-Output "Device '$oldDeviceName' found in SCCM."
            
            # Retrieve collections containing "Discovery" and with this device as a member
            $collectionsList = Get-CMDeviceCollection | Where-Object {
                $_.Name -match 'Discovery' -and (Get-CMDeviceCollectionDirectMembershipRule -CollectionId $_.CollectionID | Where-Object {$_.ResourceID -eq $device.ResourceID})
            }
            
            if ($collectionsList.Count -gt 0) {
                Update-Output "Collections retrieved for device '$oldDeviceName':"
                $collectionsList | ForEach-Object { Update-Output " - $($_.Name)" }
                
                # Enable "Check Device" button on main thread
                $window.Dispatcher.Invoke([action]{ $checkDeviceButton.IsEnabled = $true })
            } else {
                Update-Output "No discovery collections found for device '$oldDeviceName'."
            }
        } else {
            Update-Output "Device '$oldDeviceName' not found in SCCM."
        }
    } -ArgumentList $oldDeviceName
})

# Event Handler for Check Device button
$checkDeviceButton.Add_Click({
    $newDeviceName = $newDeviceNameTextBox.Text
    if ([string]::IsNullOrWhiteSpace($newDeviceName)) {
        [System.Windows.MessageBox]::Show("Please enter the new device name.", "Input Error", [System.Windows.MessageBoxButton]::OK, [System.Windows.MessageBoxImage]::Warning)
        return
    }

    # Run in a job to keep UI responsive
    Start-Job -ScriptBlock {
        param ($newDeviceName)

        # Check if the new device exists
        $newDevice = Get-CMDevice -Name $newDeviceName -ErrorAction SilentlyContinue
        if ($null -ne $newDevice) {
            Update-Output "New device '$newDeviceName' found in SCCM."
        } else {
            Update-Output "New device '$newDeviceName' NOT found in SCCM."
        }
    } -ArgumentList $newDeviceName
})

# Event Handler for Add New Device to Collections button
$addNewDeviceButton.Add_Click({
    if ($collectionsList.Count -eq 0) {
        [System.Windows.MessageBox]::Show("No collections retrieved. Please fetch collections first.", "Action Error", [System.Windows.MessageBoxButton]::OK, [System.Windows.MessageBoxImage]::Warning)
        return
    }

    $newDeviceName = $newDeviceNameTextBox.Text
    if ([string]::IsNullOrWhiteSpace($newDeviceName)) {
        [System.Windows.MessageBox]::Show("Please enter the new device name.", "Input Error", [System.Windows.MessageBoxButton]::OK, [System.Windows.MessageBoxImage]::Warning)
        return
    }

    # Run in a job to keep UI responsive
    Start-Job -ScriptBlock {
        param ($newDeviceName, $collectionsList)

        # Retrieve the new device object
        $newDevice = Get-CMDevice -Name $newDeviceName -ErrorAction SilentlyContinue
        if ($null -eq $newDevice) {
            Update-Output "New device '$newDeviceName' not found in SCCM."
            return
        }

        # Add the new device to each retrieved collection
        foreach ($collection in $collectionsList) {
            Add-CMDeviceCollectionDirectMembershipRule -CollectionId $collection.CollectionID -ResourceId $newDevice.ResourceID
            Update-Output "Added '$newDeviceName' to collection '$($collection.Name)'"
        }
    } -ArgumentList $newDeviceName, $collectionsList
})

# Show the Window
$window.ShowDialog() | Out-Null


11111111111111111111111
# Function to retrieve static device collections of a computer with filtering
function Get-StaticCollections {
    param (
        [string]$ComputerName
    )

    try {
        $device = Get-CMDevice -Name $ComputerName
        if ($device) {
            $deviceID = $device.ResourceID

            # Get all collections that contain the device (via direct membership) and have "Discovery" in their name
            $deviceCollections = Get-CMDeviceCollection | ForEach-Object {
                $collection = $_
                
                # Check if collection name contains "Discovery"
                if ($collection.Name -like "*Discovery*") {
                    # Retrieve direct membership rules for the collection
                    $rules = Get-CMDeviceCollectionDirectMembershipRule -CollectionId $collection.CollectionID
                    if ($rules.ResourceID -contains $deviceID) {
                        return $collection
                    }
                }
            } | Where-Object { $_ -ne $null }

            return $deviceCollections
        } else {
            return $null
        }
    } catch {
        Write-Warning "Failed to retrieve collections for $ComputerName - $_"
        return $null
    }
}
