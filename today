# Function to uninstall Microsoft Teams for a specific user
function Uninstall-TeamsClassic {
    param (
        [string]$TeamsPath
    )

    try {
        if (Test-Path "$TeamsPath\Update.exe") {
            Write-Host "Running Teams uninstaller at $TeamsPath"
            $process = Start-Process -FilePath "$TeamsPath\Update.exe" -ArgumentList "--uninstall /s" -PassThru -Wait -NoNewWindow
            if ($process.ExitCode -ne 0) {
                Write-Error "Uninstallation failed with exit code $($process.ExitCode)."
            } else {
                Write-Host "Successfully uninstalled Teams from $TeamsPath"
            }
        } else {
            Write-Host "Update.exe not found at $TeamsPath, skipping..."
        }
    }
    catch {
        Write-Error $_.Exception.Message
    }
}

# Remove Teams Machine-Wide Installer
$registryPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall"

Write-Host "Searching for Teams Machine-Wide Installer..."

$MachineWide = Get-ItemProperty -Path "$registryPath\*" -ErrorAction SilentlyContinue | 
               Where-Object { $_.DisplayName -eq "Teams Machine-Wide Installer" }

if ($MachineWide) {
    Write-Host "Found Teams Machine-Wide Installer. Uninstalling..."
    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($MachineWide.PSChildName) /qn" -NoNewWindow -Wait
    Write-Host "Teams Machine-Wide Installer removed."
} else {
    Write-Host "Teams Machine-Wide Installer not found."
}

# Remove Microsoft Teams for All Users
Write-Host "Searching for Teams installations for all users..."

$AllUsers = Get-ChildItem -Path "$($ENV:SystemDrive)\Users"

foreach ($User in $AllUsers) {
    Write-Host "Processing user: $($User.Name)"

    # Define Installation Paths
    $localAppData = "$($ENV:SystemDrive)\Users\$($User.Name)\AppData\Local\Microsoft\Teams"
    $programData = "$($env:ProgramData)\$($User.Name)\Microsoft\Teams"

    if (Test-Path "$localAppData\Current\Teams.exe") {
        Write-Host "Uninstalling Teams for user $($User.Name) from LocalAppData"
        Uninstall-TeamsClassic -TeamsPath $localAppData
    }
    elseif (Test-Path "$programData\Current\Teams.exe") {
        Write-Host "Uninstalling Teams for user $($User.Name) from ProgramData"
        Uninstall-TeamsClassic -TeamsPath $programData
    }
    else {
        Write-Host "No Teams installation found for user $($User.Name)."
    }
}

# Uninstall Microsoft Teams Meeting Add-in for Microsoft Office
Write-Host "Searching for Microsoft Teams Meeting Add-in for Microsoft Office..."

$registryPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

$addInName = "Microsoft Teams Meeting Add-in for Microsoft Office"

foreach ($regPath in $registryPaths) {
    $installedApps = Get-ItemProperty -Path "$regPath\*" -ErrorAction SilentlyContinue |
                     Where-Object { $_.DisplayName -like $addInName }

    foreach ($app in $installedApps) {
        if ($app) {
            Write-Host "Found $addInName. Checking install location..."

            # Get InstalledLocation or InstallSource (PowerShell 5.1 Compatible)
            $installedSource = if ($app.PSObject.Properties['InstalledLocation']) { 
                $app.InstalledLocation 
            } elseif ($app.PSObject.Properties['InstallSource']) { 
                $app.InstallSource 
            } else { 
                $null 
            }

            if ($installedSource -and ($installedSource -notlike "C:\Program Files\WindowsApps*")) {
                Write-Host "Uninstalling $addInName from $installedSource"

                if ($app.PSChildName -match "^{.*}$") {
                    # MSI-based uninstall
                    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($app.PSChildName) /qn" -NoNewWindow -Wait
                }
                elseif ($app.UninstallString) {
                    # EXE-based uninstall
                    $uninstallCmd = $app.UninstallString
                    Write-Host "Running: $uninstallCmd"
                    Start-Process -FilePath "cmd.exe" -ArgumentList "/c $uninstallCmd" -NoNewWindow -Wait
                }

                Write-Host "$addInName successfully uninstalled."
            } else {
                Write-Host "$addInName is installed in WindowsApps and will not be removed."
            }
        }
    }
}

# Remove Leftover Teams Folders & Icons
Write-Host "Removing old Teams folders and shortcuts..."

$TeamsFolders = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Local\Microsoft\Teams" -ErrorAction SilentlyContinue
$TeamsIcons = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\" -Filter "Microsoft Teams*.lnk" -Recurse -ErrorAction SilentlyContinue

foreach ($folder in $TeamsFolders) {
    Write-Host "Removing: $($folder.FullName)"
    Remove-Item -Path $folder.FullName -Force -Recurse -ErrorAction SilentlyContinue
}

foreach ($icon in $TeamsIcons) {
    Write-Host "Removing: $($icon.FullName)"
    Remove-Item -Path $icon.FullName -Force -ErrorAction SilentlyContinue
}

Write-Host "Microsoft Teams and related components have been successfully uninstalled!"


#2 nd script

# Define Registry Paths
$registryPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

# Define the Add-in Display Name
$addInName = "Microsoft Teams Meeting Add-in for Microsoft Office"

Write-Host "Searching for $addInName in the registry..."

foreach ($registryPath in $registryPaths) {
    # Retrieve installed applications
    $installedApps = Get-ItemProperty -Path "$registryPath\*" -ErrorAction SilentlyContinue |
                     Where-Object { $_.DisplayName -like $addInName }

    foreach ($app in $installedApps) {
        if ($app) {
            Write-Host "Found $addInName. Checking install location..."

            # Check InstalledLocation/InstalledSource
            $installedSource = $app.InstalledLocation ?? $app.InstallSource

            if ($installedSource -and ($installedSource -notlike "C:\Program Files\WindowsApps*")) {
                Write-Host "Uninstalling $addInName from $installedSource"
                
                # Execute the uninstallation
                if ($app.PSChildName -match "^{.*}$") {
                    # If it's an MSI-based uninstall
                    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($app.PSChildName) /qn" -NoNewWindow -Wait
                }
                elseif ($app.UninstallString) {
                    # If it's an EXE-based uninstall
                    $uninstallCmd = $app.UninstallString
                    Write-Host "Running: $uninstallCmd"
                    Start-Process -FilePath "cmd.exe" -ArgumentList "/c $uninstallCmd" -NoNewWindow -Wait
                }

                Write-Host "$addInName successfully uninstalled."
            }
            else {
                Write-Host "$addInName is installed in WindowsApps and will not be uninstalled."
            }
        }
    }
}

Write-Host "Uninstallation process completed."


!st Script

function Uninstall-TeamsClassic {
    param (
        [string]$TeamsPath
    )

    try {
        if (Test-Path "$TeamsPath\Update.exe") {
            $process = Start-Process -FilePath "$TeamsPath\Update.exe" -ArgumentList "--uninstall /s" -PassThru -Wait -NoNewWindow
            if ($process.ExitCode -ne 0) {
                Write-Error "Uninstallation failed with exit code $($process.ExitCode)."
            } else {
                Write-Host "Successfully uninstalled Teams from $TeamsPath"
            }
        } else {
            Write-Host "Update.exe not found at $TeamsPath, skipping..."
        }
    }
    catch {
        Write-Error $_.Exception.Message
    }
}

# Define Registry Path for Machine-Wide Installer
$registryPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall"

Write-Host "Removing Teams Machine-Wide Installer..."

# Find Teams Machine-Wide Installer
$MachineWide = Get-ItemProperty -Path "$registryPath\*" | Where-Object { $_.DisplayName -eq "Teams Machine-Wide Installer" }

if ($MachineWide) {
    Write-Host "Found Teams Machine-Wide Installer. Uninstalling..."
    Start-Process -FilePath "msiexec.exe" -ArgumentList "/x $($MachineWide.PSChildName) /qn" -NoNewWindow -Wait
} else {
    Write-Host "Teams Machine-Wide Installer not found."
}

# Get All Users
$AllUsers = Get-ChildItem -Path "$($ENV:SystemDrive)\Users"

# Process Each User
foreach ($User in $AllUsers) {
    Write-Host "Processing user: $($User.Name)"

    # Define Installation Paths
    $localAppData = "$($ENV:SystemDrive)\Users\$($User.Name)\AppData\Local\Microsoft\Teams"
    $programData = "$($env:ProgramData)\$($User.Name)\Microsoft\Teams"

    if (Test-Path "$localAppData\Current\Teams.exe") {
        Write-Host "  Uninstalling Teams for user $($User.Name) from LocalAppData"
        Uninstall-TeamsClassic -TeamsPath $localAppData
    }
    elseif (Test-Path "$programData\Current\Teams.exe") {
        Write-Host "  Uninstalling Teams for user $($User.Name) from ProgramData"
        Uninstall-TeamsClassic -TeamsPath $programData
    }
    else {
        Write-Host "  No Teams installation found for user $($User.Name)."
    }
}

# Remove Old Teams Folders and Icons
Write-Host "Removing old Teams folders and icons..."

$TeamsFolders = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Local\Microsoft\Teams" -ErrorAction SilentlyContinue
$TeamsIcons = Get-ChildItem -Path "$($ENV:SystemDrive)\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\" -Filter "Microsoft Teams*.lnk" -Recurse -ErrorAction SilentlyContinue

foreach ($folder in $TeamsFolders) {
    Write-Host "Removing: $($folder.FullName)"
    Remove-Item -Path $folder.FullName -Force -Recurse
}

foreach ($icon in $TeamsIcons) {
    Write-Host "Removing: $($icon.FullName)"
    Remove-Item -Path $icon.FullName -Force
}

Write-Host "Teams uninstallation process completed."
